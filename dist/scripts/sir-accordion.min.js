"use strict";angular.module("sir-accordion",[]).directive("sirNgAccordion",["$compile","$timeout",function(e,o){var n="";return{restrict:"A",scope:{collection:"=",config:"=?"},template:n,controller:["$scope",function(e){e.config={debug:"undefined"!=typeof e.config.debug?e.config.debug:!1,animDur:e.config.animDur>=200&&document.body.firstElementChild?e.config.animDur:0,expandFirst:"undefined"!=typeof e.config.expandFirst?e.config.expandFirst:!1,autoCollapse:"undefined"!=typeof e.config.autoCollapse?e.config.autoCollapse:!0,watchInternalChanges:"undefined"!=typeof e.config.watchInternalChanges?e.config.watchInternalChanges:!1,headerClass:e.config.headerClass||"",preHeader:e.config.preHeader||'<div class="sir-accordion-vertical-align"><div>',postHeader:e.config.postHeader||"</div></div>",topContentClass:e.config.topContentClass||"",preTopContent:e.config.preTopContent||"",postTopContent:e.config.postTopContent||"",bottomContentClass:e.config.bottomContentClass||"",preBottomContent:e.config.preBottomContent||"",postBottomContent:e.config.postBottomContent||""}}],link:function(n,t){var i=n.config.animDur,a="",d="",l="",r="",s="",c="",f=[],g=[],u=[],h="0",p="background: #0044CE; color: #fff",v=null;n.$watch("collection",function(){if(!angular.isArray(n.collection))return void t.html("No collection found");a="",d="",l="",r="",s="",c="",f=[],g=[],u=[],h="0",c=C(n.collection,0,0,0),t.html(""),v&&(v.$destroy(),v=null),v=n.$new();var o=e(c)(v);t.append(o),b(),n.$emit("sacDoneLoading")},n.config.watchInternalChanges);var b=function(){for(var e=null,o=null,n=null,t=g.length-1;t>=0;t--)e=document.getElementById("sac"+g[t]),o=e.firstElementChild?e.firstElementChild:e.firstChild,n=o.nextSibling,g[t]={id:e.id,obj:n},f[t]={id:e.id,obj:o},e.firstElementChild&&(g[t].obj.firstElementChild.style.transition="all "+(i-100)+"ms",f[t].obj.style.transition="all "+i+"ms")},C=function(e,o,t,i){return t==e.length?"":(s=i?String(o)+"-"+String(t+1):String(t+1),a=n.config.preHeader+e[t].title+n.config.postHeader,d=m(n.config.preTopContent,e[t].topContent,n.config.postTopContent),g.push(s),r='<div id="sac'+s+'" > <div class="sir-accordion-header '+n.config.headerClass+'" ng-click="expandCollapse(\''+s+"')\">"+a+'</div><div class="sir-accordion-content"> <div><div class="'+n.config.topContentClass+'">'+d+"</div>",0==t&&(r=0==i?'<div class="sir-accordion-wrapper">'+r:'<div class="sir-accordion-group">'+r),l=m(n.config.preBottomContent,e[t].bottomContent,n.config.postBottomContent),angular.isArray(e[t].subCollection)&&e[t].subCollection.length?(r+=C(e[t].subCollection,s,0,i+1),r=r+'</div><div class="'+n.config.bottomContentClass+'">'+l+"</div></div></div></div>"):r=r+'</div><div class="'+n.config.bottomContentClass+'">'+l+"</div></div></div>",r+C(e,o,t+1,i))},m=function(e,o,n){return o=o?e+o+n:""},x=function(e,o){n.config.debug&&console.log("Chain collapsing");do{for(var t=g.length-1;t>=0;t--)n.config.autoCollapse&&g[t].id=="sac"+e?(H(g[t],"expanded"),H(f[t],"active-header")):y(g[t].id)==y(e)&&g[t].obj.className.indexOf("expanded")>-1&&(H(g[t],"expanded"),H(f[t],"active-header"));e=y(e)}while(j(e)!=o)},j=function(e){return"0"==e?0:e.split("-").length},y=function(e){if(-1==e.indexOf("-"))return"0";var o="";do o=e.substr(e.length-1),e=e.slice(0,-1);while("-"!=o);return e=e.replace("sac","")},H=function(e,o){if(e.obj.className.indexOf(o)>-1)return e.obj.className=e.obj.className.replace(o,""),n.config.debug&&console.log("removing class "+e.id),"expanded"==o&&w(e,0),!1;if(e.obj.className=E(e.obj.className)+" "+o,n.config.debug&&console.log("adding class "+e.id),"expanded"==o){var t=e.obj.firstChild.offsetHeight||e.obj.firstElementChild.offsetHeight;w(e,t)}return!0},N=function(e,o){do{if(y(o)==e)return!0;o=y(o)}while(j(o)>j(e));return!1},E=function(e){for(var e=e.replace(/^\s\s*/,""),o=/\s/,n=e.length;o.test(e.charAt(--n)););return e.slice(0,n+1)},O=function(e){return e.style.height.substr(0,e.style.height.length-2)},w=function(e,t){u.push(e.id),o(function(){u=[],e.obj.style.transition="height 0s","0px"!=e.obj.style.height&&(e.obj.style.height="auto"),n.config.autoCollapse||D()},i),e.obj.style.transition="height "+i+"ms",i?o(function(){e.obj.style.height=t+"px"},80):e.obj.style.height=t+"px"},$=function(e){for(var o=g.length-1;o>=0;o--)if(g[o].id=="sac"+e||g[o].id==e)return o;return-1},B=function(){for(var e=g.length-1;e>=0;e--)if("auto"==g[e].obj.style.height){var o=g[e].obj.firstChild.offsetHeight||g[e].obj.firstElementChild.offsetHeight;g[e].obj.style.height=o+"px"}},D=function(){for(var e=g.length-1;e>=0;e--)if("0px"!=g[e].obj.style.height&&g[e].obj.style.height){{var o=g[e].obj;o.firstChild.offsetHeight||o.firstElementChild.offsetHeight}o.style.height="auto"}},A=function(e,o){for(var n=e.length-1;n>=0;n--)N(o,e[n].id)&&e[n].obj.className.indexOf("expanded")>-1&&(H(e[n],"expanded"),H(f[n],"active-header"))},F=function(e){var o=$(e),t=$(h),i=g[o],a=f[o],d=i.obj.firstChild.offsetHeight||i.obj.firstElementChild.offsetHeight;if(B(),!n.config.autoCollapse){i.obj.className.indexOf("expanded")>-1&&A(g,e);var l=H(i,"expanded");for(H(a,"active-header");j(i.id)>=2;)i=g[$(y(i.id))],l?w(i,i.obj.offsetHeight+d):w(i,i.obj.offsetHeight-d);return void(h=e)}if("0"==h)return H(a,"active-header"),H(i,"expanded"),h=e,n.config.debug&&console.log("%c Opening First",p),void(n.config.debug&&console.log("From 0 to "+h));if(h==e){for(H(i,"expanded"),H(a,"active-header"),h=y(e)||"0";j(i.id)>=2;)i=g[$(y(i.id))],w(i,i.obj.offsetHeight-d);return n.config.debug&&console.log("%c Closing same",p),void(n.config.debug&&console.log("From current element to "+h))}if(h!=e){if(y(e)==h){for(n.config.debug&&console.log("%c Opening Child",p),H(i,"expanded"),H(a,"active-header"),h=e;j(i.id)>=2;)i=g[$(y(i.id))],w(i,i.obj.offsetHeight+d);return}if(N(e,h)){for(n.config.debug&&console.log("%c Closing Parent",p),x(h,j(e)),H(i,"expanded"),H(a,"active-header"),h=y(e);j(i.id)>=2;)i=g[$(y(i.id))],w(i,i.obj.offsetHeight-d);return}if(y(h)==y(e)){n.config.debug&&console.log("%c Opening sibling",p);var r=O(g[t].obj);for(H(g[t],"expanded"),H(f[t],"active-header"),H(a,"active-header"),H(i,"expanded"),h=e;j(i.id)>=2;)i=g[$(y(i.id))],w(i,i.obj.offsetHeight+d-r);return}if(n.config.debug&&console.log("%c Opening other",p),j(e)>=2){for(var s=g[$(y(h))],c=g[$(y(i.id))];j(s.id)>j(e);)s=g[$(y(s.id))];for(;c&&j(c.id)>=1;)w(c,c.obj.offsetHeight+d-s.obj.offsetHeight),c=g[$(y(c.id))]}return x(h,j(y(e))),H(a,"active-header"),h=e,void H(i,"expanded")}},I=function(e){i=0;for(var t=e.split("-"),a="",d=0;d<t.length;d++){for(var l=0;d>=l;l++)a=l?a+"-"+t[l]:t[l];-1==g[$(a)].obj.className.indexOf("expanded")&&F(a),a=""}o(function(){i=n.config.animDur},n.config.animDur)};n.expandCollapse=function(e){F(e)},n.$on("sacCollapseAll",function(e){if(B(),!n.config.autoCollapse)for(var o=g.length-1;o>=0;o--)g[o].obj.className.indexOf("expanded")>-1&&(H(f[o],"active-header"),H(g[o],"expanded"));e.defaultPrevented=!0}),n.$on("sacExpandAll",function(e){if(!n.config.autoCollapse){i=0;for(var o=g.length-1;o>=0;o--)-1==g[o].obj.className.indexOf("expanded")&&j(g[o].id)>1&&(H(f[o],"active-header"),H(g[o],"expanded"),g[o].obj.style.height="auto");i=n.config.animDur;for(var o=g.length-1;o>=0;o--)-1==g[o].obj.className.indexOf("expanded")&&1==j(g[o].id)&&(H(f[o],"active-header"),H(g[o],"expanded"))}e.defaultPrevented=!0}),n.$on("sacExpandContentById",function(e,o){I(o),e.defaultPrevented=!0})}}}]);