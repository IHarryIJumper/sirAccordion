"use strict";angular.module("sir-accordion",[]).directive("sirNgAccordion",["$compile","$timeout",function(e,o){var n="";return{restrict:"A",scope:{collection:"=",config:"=?"},template:n,controller:["$scope",function(e){e.config={debug:"undefined"!=typeof e.config.debug?e.config.debug:!1,animDur:e.config.animDur>=200&&document.body.firstElementChild?e.config.animDur:0,expandFirst:"undefined"!=typeof e.config.expandFirst?e.config.expandFirst:!1,autoCollapse:"undefined"!=typeof e.config.autoCollapse?e.config.autoCollapse:!0,watchInternalChanges:"undefined"!=typeof e.config.watchInternalChanges?e.config.watchInternalChanges:!1,headerClass:e.config.headerClass||"",preHeader:e.config.preHeader||'<div class="sir-accordion-vertical-align"><div>',postHeader:e.config.postHeader||"</div></div>",topContentClass:e.config.topContentClass||"",preTopContent:e.config.preTopContent||"",postTopContent:e.config.postTopContent||"",bottomContentClass:e.config.bottomContentClass||"",preBottomContent:e.config.preBottomContent||"",postBottomContent:e.config.postBottomContent||""}}],link:function(n,i){var t=n.config.animDur,a="",s="",d="",l="",c="",r="",f=[],g=[],h=[],u="0",p="background: #0044CE; color: #fff",v=null;n.$watch("collection",function(){if(!angular.isArray(n.collection))return void i.html("No collection found");a="",s="",d="",l="",c="",r="",f=[],g=[],h=[],u="0",r=b(n.collection,0,0,0),i.html(""),v&&(v.$destroy(),v=null),v=n.$new();var o=e(r)(v);i.append(o),C()},n.config.watchInternalChanges);var C=function(){for(var e=null,o=null,n=null,i=g.length-1;i>=0;i--)e=document.getElementById("sac"+g[i]),o=e.firstElementChild?e.firstElementChild:e.firstChild,n=o.nextSibling,g[i]={id:e.id,obj:n},f[i]={id:e.id,obj:o},e.firstElementChild&&(g[i].obj.firstElementChild.style.transition="all "+(t-100)+"ms",f[i].obj.style.transition="all "+t+"ms")},b=function(e,o,i,t){return i==e.length?"":(c=t?String(o)+"-"+String(i+1):String(i+1),a=n.config.preHeader+e[i].title+n.config.postHeader,s=m(n.config.preTopContent,e[i].topContent,n.config.postTopContent),g.push(c),l=0==i?0==t?'<div class="sir-accordion-wrapper"> <div id="sac'+c+'" > <div class="sir-accordion-header '+n.config.headerClass+'" ng-click= "expandCollapse(\''+c+'\')" class="'+n.config.headerClass+'">'+a+'</div><div class="sir-accordion-content"> <div><div class="'+n.config.topContentClass+'">'+s+"</div>":'<div class="sir-accordion-group"> <div id="sac'+c+'" > <div class="sir-accordion-header '+n.config.headerClass+'" ng-click="expandCollapse(\''+c+'\')" class="'+n.config.headerClass+'">'+a+'</div><div class="sir-accordion-content"> <div><div class="'+n.config.topContentClass+'">'+s+"</div>":'<div id="sac'+c+'" > <div class="sir-accordion-header '+n.config.headerClass+'" ng-click="expandCollapse(\''+c+'\')" class="'+n.config.headerClass+'">'+a+'</div><div class="sir-accordion-content"> <div><div class="'+n.config.topContentClass+'">'+s+"</div>",angular.isArray(e[i].subCollection)&&e[i].subCollection.length?(l+=b(e[i].subCollection,c,0,t+1),d=m(n.config.preBottomContent,e[i].bottomContent,n.config.postBottomContent),l=l+'</div><div class="'+n.config.bottomContentClass+'">'+d+"</div></div></div></div>"):(d=m(n.config.preBottomContent,e[i].bottomContent,n.config.postBottomContent),l=l+'</div><div class="'+n.config.bottomContentClass+'">'+d+"</div></div></div>"),l+b(e,o,i+1,t))},m=function(e,o,n){return o=o?e+o+n:""},j=function(e,o){n.config.debug&&console.log("Chain collapsing");do{for(var i=g.length-1;i>=0;i--)n.config.autoCollapse&&g[i].id=="sac"+e?(H(g[i],"expanded"),H(f[i],"active-header")):y(g[i].id)==y(e)&&g[i].obj.className.indexOf("expanded")>-1&&(H(g[i],"expanded"),H(f[i],"active-header"));e=y(e)}while(x(e)!=x(o))},x=function(e){return"0"==e?0:e.split("-").length},y=function(e){if(-1==e.indexOf("-"))return"0";var o="";do o=e.substr(e.length-1),e=e.slice(0,-1);while("-"!=o);return e=e.replace("sac","")},H=function(e,o){if(e.obj.className.indexOf(o)>-1)return e.obj.className=e.obj.className.replace(o,""),n.config.debug&&console.log("removing class "+e.id),"expanded"==o&&B(e,0),!1;if(e.obj.className=O(e.obj.className)+" "+o,n.config.debug&&console.log("adding class "+e.id),"expanded"==o){var i=e.obj.firstChild.offsetHeight||e.obj.firstElementChild.offsetHeight;B(e,i)}return!0},N=function(e,o){do{if(y(o)==e)return!0;o=y(o)}while(x(o)>x(e));return!1},O=function(e){for(var e=e.replace(/^\s\s*/,""),o=/\s/,n=e.length;o.test(e.charAt(--n)););return e.slice(0,n+1)},E=function(e){return h.length?!0:!1},w=function(e){return e.style.height.substr(0,e.style.height.length-2)},B=function(e,i){h.push(e.id),o(function(){h=[],e.obj.style.transition="height 0s","0px"!=e.obj.style.height&&(e.obj.style.height="auto"),n.config.autoCollapse||F()},t),e.obj.style.transition="height "+t+"ms",o(function(){e.obj.style.height=i+"px"},40)},$=function(e){for(var o=g.length-1;o>=0;o--)if(g[o].id=="sac"+e||g[o].id==e)return o;return-1},A=function(){for(var e=g.length-1;e>=0;e--)if("auto"==g[e].obj.style.height){var o=g[e].obj.firstChild.offsetHeight||g[e].obj.firstElementChild.offsetHeight;g[e].obj.style.height=o+"px"}},F=function(){for(var e=g.length-1;e>=0;e--)if("0px"!=g[e].obj.style.height&&g[e].obj.style.height){{g[e].obj.firstChild.offsetHeight||g[e].obj.firstElementChild.offsetHeight}g[e].obj.style.height="auto"}},T=function(e,o){for(var n=e.length-1;n>=0;n--)N(o,e[n].id)&&e[n].obj.className.indexOf("expanded")>-1&&(H(e[n],"expanded"),H(f[n],"active-header"))};n.expandCollapse=function(e){var o=$(e),i=$(u),t=g[o],a=f[o],s=t.obj.firstChild.offsetHeight||t.obj.firstElementChild.offsetHeight;if(!t.id||!E(t.id)){if(A(),!n.config.autoCollapse){t.obj.className.indexOf("expanded")>-1&&T(g,e);var d=H(t,"expanded");for(H(a,"active-header");x(t.id)>=2;)t=g[$(y(t.id))],d?B(t,t.obj.offsetHeight+s):B(t,t.obj.offsetHeight-s);return void(u=e)}if("0"==u)return H(a,"active-header"),H(t,"expanded"),u=e,n.config.debug&&console.log("%c Opening First",p),void(n.config.debug&&console.log("From 0 to "+u));if(u==e){for(H(t,"expanded"),H(a,"active-header"),u=y(e)||"0";x(t.id)>=2;)t=g[$(y(t.id))],B(t,t.obj.offsetHeight-s);return n.config.debug&&console.log("%c Closing same",p),void(n.config.debug&&console.log("From current element to "+u))}if(u!=e&&!h.length){if(y(e)==u){for(n.config.debug&&console.log("%c Opening Child",p),H(t,"expanded"),H(a,"active-header"),u=e;x(t.id)>=2;)t=g[$(y(t.id))],B(t,t.obj.offsetHeight+s);return}if(N(e,u)){for(n.config.debug&&console.log("%c Closing Parent",p),j(u,e),H(t,"expanded"),H(a,"active-header"),u=y(e);x(t.id)>=2;)t=g[$(y(t.id))],B(t,t.obj.offsetHeight-s);return}if(y(u)==y(e)){n.config.debug&&console.log("%c Opening sibling",p);var l=w(g[i].obj);for(H(g[i],"expanded"),H(f[i],"active-header"),H(a,"active-header"),H(t,"expanded"),u=e;x(t.id)>=2;)t=g[$(y(t.id))],B(t,t.obj.offsetHeight+s-l);return}if(n.config.debug&&console.log("%c Opening other",p),x(e)>=2){for(var c=g[$(y(u))],r=g[$(y(t.id))];x(c.id)>x(e);)c=g[$(y(c.id))];for(;r&&x(r.id)>=1;)B(r,r.obj.offsetHeight+s-c.obj.offsetHeight),r=g[$(y(r.id))]}return j(u,y(e)),H(a,"active-header"),u=e,void H(t,"expanded")}}},n.$on("collapseAll",function(e){if(A(),!n.config.autoCollapse)for(var o=g.length-1;o>=0;o--)g[o].obj.className.indexOf("expanded")>-1&&(H(f[o],"active-header"),H(g[o],"expanded"));e.defaultPrevented=!0}),n.$on("expandAll",function(e){if(!n.config.autoCollapse){t=0;for(var o=g.length-1;o>=0;o--)-1==g[o].obj.className.indexOf("expanded")&&x(g[o].id)>1&&(H(f[o],"active-header"),H(g[o],"expanded"),g[o].obj.style.height="auto");t=n.config.animDur;for(var o=g.length-1;o>=0;o--)-1==g[o].obj.className.indexOf("expanded")&&1==x(g[o].id)&&(H(f[o],"active-header"),H(g[o],"expanded"))}e.defaultPrevented=!0})}}}]);