"use strict";angular.module("sir-accordion",[]).directive("sirNgAccordion",["$compile","$timeout",function(e,t){var n="";return{restrict:"A",scope:{collection:"=",config:"=?"},template:n,controller:("sirNgAccordionCtrl",["$scope",function(e){e.config={debug:typeof e.config.debug!="undefined"?e.config.debug:false,animDur:e.config.animDur>=200&&document.body.firstElementChild?e.config.animDur:0,expandFirst:typeof e.config.expandFirst!="undefined"?e.config.expandFirst:false,autoCollapse:typeof e.config.autoCollapse!="undefined"?e.config.autoCollapse:true,headerClass:e.config.headerClass||"",preHeader:e.config.preHeader||'<div class="sir-accordion-vertical-align"><div>',postHeader:e.config.postHeader||"</div></div>",topContentClass:e.config.topContentClass||"",preTopContent:e.config.preTopContent||"",postTopContent:e.config.postTopContent||"",bottomContentClass:e.config.bottomContentClass||"",preBottomContent:e.config.preBottomContent||"",postBottomContent:e.config.postBottomContent||""}}]),link:function(n,r){var i=n.config.animDur;var s="";var o="";var u="";var a="";var f="";var l="";var c=[];var h=[];var p=[];var d="0";var v="background: #0044CE; color: #fff";n.$watch("collection",function(){if(!angular.isArray(n.collection)){r.html("No collection found");return}s="";o="";u="";a="";f="";l="";c=[];h=[];p=[];d="0";l=g(n.collection,0,0,0);e(l)(n,function(e,t){r.html("");r.append(e)});m()});var m=function(){var e=null;var t=null;var n=null;for(var r=h.length-1;r>=0;r--){e=document.getElementById("sac"+h[r]);t=e.firstElementChild?e.firstElementChild:e.firstChild;n=t.nextSibling;h[r]={id:e.id,obj:n};c[r]={id:e.id,obj:t};if(e.firstElementChild){h[r].obj.firstElementChild.style.transition="all "+(i-100)+"ms";c[r].obj.style.transition="all "+i+"ms"}}};var g=function(e,t,r,i){if(r==e.length){return""}f=i?String(t)+"-"+String(r+1):String(r+1);s=n.config.preHeader+e[r].title+n.config.postHeader;o=y(n.config.preTopContent,e[r].topContent,n.config.postTopContent);h.push(f);if(r==0){if(i==0){a='<div class="sir-accordion-wrapper"> <div id="sac'+f+'" > <div class="sir-accordion-header '+n.config.headerClass+'" ng-click= "expandCollapse(\''+f+'\')" class="'+n.config.headerClass+'">'+s+"</div>"+'<div class="sir-accordion-content"> <div><div class="'+n.config.topContentClass+'">'+o+"</div>"}else{a='<div class="sir-accordion-group"> <div id="sac'+f+'" > <div class="sir-accordion-header '+n.config.headerClass+'" ng-click="expandCollapse(\''+f+'\')" class="'+n.config.headerClass+'">'+s+"</div>"+'<div class="sir-accordion-content"> <div><div class="'+n.config.topContentClass+'">'+o+"</div>"}}else{a='<div id="sac'+f+'" > <div class="sir-accordion-header '+n.config.headerClass+'" ng-click="expandCollapse(\''+f+'\')" class="'+n.config.headerClass+'">'+s+"</div>"+'<div class="sir-accordion-content"> <div><div class="'+n.config.topContentClass+'">'+o+"</div>"}if(angular.isArray(e[r].subCollection)&&e[r].subCollection.length){a=a+g(e[r].subCollection,f,0,i+1);u=y(n.config.preBottomContent,e[r].bottomContent,n.config.postBottomContent);a=a+'</div><div class="'+n.config.bottomContentClass+'">'+u+"</div></div></div></div>"}else{u=y(n.config.preBottomContent,e[r].bottomContent,n.config.postBottomContent);a=a+'</div><div class="'+n.config.bottomContentClass+'">'+u+"</div></div></div>"}return a+g(e,t,r+1,i)};var y=function(e,t,n){if(!t){t=""}else{t=e+t+n}return t};var b=function(e,t){if(n.config.debug)console.log("Chain collapsing");do{for(var r=h.length-1;r>=0;r--){if(n.config.autoCollapse&&h[r].id=="sac"+e){S(h[r],"expanded");S(c[r],"active-header")}else if(E(h[r].id)==E(e)&&h[r].obj.className.indexOf("expanded")>-1){S(h[r],"expanded");S(c[r],"active-header")}}e=E(e)}while(w(e)!=w(t))};var w=function(e){if(e=="0")return 0;else return e.split("-").length};var E=function(e){if(e.indexOf("-")==-1){return"0"}var t="";do{t=e.substr(e.length-1);e=e.slice(0,-1)}while(t!="-");e=e.replace("sac","");return e};var S=function(e,t){if(e.obj.className.indexOf(t)>-1){e.obj.className=e.obj.className.replace(t,"");if(n.config.debug)console.log("removing class "+e.id);if(t=="expanded"){k(e,0)}return false}else{e.obj.className=T(e.obj.className)+" "+t;if(n.config.debug)console.log("adding class "+e.id);if(t=="expanded"){var r=e.obj.firstChild.offsetHeight||e.obj.firstElementChild.offsetHeight;k(e,r)}return true}};var x=function(e,t){do{if(E(t)==e)return true;t=E(t)}while(w(t)>w(e));return false};var T=function(e){var e=e.replace(/^\s\s*/,""),t=/\s/,n=e.length;while(t.test(e.charAt(--n)));return e.slice(0,n+1)};var N=function(e){if(p.length)return true;return false;for(var t=p.length-1;t>=0;t--){if(p[t]==e){return true}}return false};var C=function(e){return e.style.height.substr(0,e.style.height.length-2)};var k=function(e,r){p.push(e.id);t(function(){p=[];e.obj.style.transition="height 0s";if(e.obj.style.height!="0px"){e.obj.style.height="auto"}if(!n.config.autoCollapse){O()}},i);e.obj.style.transition="height "+i+"ms";t(function(){e.obj.style.height=r+"px"},40)};var L=function(e){for(var t=h.length-1;t>=0;t--){if(h[t].id=="sac"+e||h[t].id==e)return t}return-1};var A=function(){for(var e=h.length-1;e>=0;e--){if(h[e].obj.style.height=="auto"){var t=h[e].obj.firstChild.offsetHeight||h[e].obj.firstElementChild.offsetHeight;h[e].obj.style.height=t+"px"}}};var O=function(){for(var e=h.length-1;e>=0;e--){if(h[e].obj.style.height!="0px"&&h[e].obj.style.height){var t=h[e].obj.firstChild.offsetHeight||h[e].obj.firstElementChild.offsetHeight;h[e].obj.style.height="auto"}}};var M=function(e,t){for(var n=e.length-1;n>=0;n--){if(x(t,e[n].id)&&e[n].obj.className.indexOf("expanded")>-1){S(e[n],"expanded");S(c[n],"active-header")}}};n.expandCollapse=function(e){var t=L(e);var r=L(d);var i=h[t];var s=c[t];var o=i.obj.firstChild.offsetHeight||i.obj.firstElementChild.offsetHeight;if(i.id&&N(i.id))return;A();if(n.config.autoCollapse){if(d=="0"){S(s,"active-header");S(i,"expanded");d=e;if(n.config.debug)console.log("%c Opening First",v);if(n.config.debug)console.log("From 0 to "+d);return}if(d==e){S(i,"expanded");S(s,"active-header");d=E(e)||"0";while(w(i.id)>=2){i=h[L(E(i.id))];k(i,i.obj.offsetHeight-o)}if(n.config.debug)console.log("%c Closing same",v);if(n.config.debug)console.log("From current element to "+d);return}if(d!=e&&!p.length){if(E(e)==d){if(n.config.debug)console.log("%c Opening Child",v);S(i,"expanded");S(s,"active-header");d=e;while(w(i.id)>=2){i=h[L(E(i.id))];k(i,i.obj.offsetHeight+o)}return}else if(x(e,d)){if(n.config.debug)console.log("%c Closing Parent",v);b(d,e);S(i,"expanded");S(s,"active-header");d=E(e);while(w(i.id)>=2){i=h[L(E(i.id))];k(i,i.obj.offsetHeight-o)}return}else if(E(d)==E(e)){if(n.config.debug)console.log("%c Opening sibling",v);var u=C(h[r].obj);S(h[r],"expanded");S(c[r],"active-header");S(s,"active-header");S(i,"expanded");d=e;while(w(i.id)>=2){i=h[L(E(i.id))];k(i,i.obj.offsetHeight+o-u)}return}else{if(n.config.debug)console.log("%c Opening other",v);if(w(e)>=2){var a=h[L(E(d))];var f=h[L(E(i.id))];while(w(a.id)>w(e)){a=h[L(E(a.id))]}while(f&&w(f.id)>=1){k(f,f.obj.offsetHeight+o-a.obj.offsetHeight);f=h[L(E(f.id))]}}b(d,E(e));S(s,"active-header");d=e;S(i,"expanded");return}return false}}else{if(i.obj.className.indexOf("expanded")>-1){M(h,e)}var l=S(i,"expanded");S(s,"active-header");while(w(i.id)>=2){i=h[L(E(i.id))];if(l){k(i,i.obj.offsetHeight+o)}else{k(i,i.obj.offsetHeight-o)}}d=e;return}};n.$on("collapseAll",function(e){A();if(!n.config.autoCollapse){for(var t=h.length-1;t>=0;t--){if(h[t].obj.className.indexOf("expanded")>-1){S(c[t],"active-header");S(h[t],"expanded")}}}e.defaultPrevented=true});n.$on("expandAll",function(e,t){if(!n.config.autoCollapse){i=0;for(var r=h.length-1;r>=0;r--){if(h[r].obj.className.indexOf("expanded")==-1&&w(h[r].id)>1){S(c[r],"active-header");S(h[r],"expanded");h[r].obj.style.height="auto"}}i=n.config.animDur;for(var r=h.length-1;r>=0;r--){if(h[r].obj.className.indexOf("expanded")==-1&&w(h[r].id)==1){S(c[r],"active-header");S(h[r],"expanded")}}}e.defaultPrevented=true})}}}])