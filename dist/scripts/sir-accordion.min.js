"use strict";angular.module("sir-accordion",[]).directive("sirAccordion",["$compile","$timeout",function(e,n){var o="";return{restrict:"A",scope:{collection:"=",config:"=?",data:"=?"},template:o,controller:["$scope",function(e){e.config={debug:"undefined"!=typeof e.config.debug?e.config.debug:!1,animDur:e.config.animDur>=0&&document.body.firstElementChild?e.config.animDur:0,expandFirst:"undefined"!=typeof e.config.expandFirst?e.config.expandFirst:!1,autoCollapse:"undefined"!=typeof e.config.autoCollapse?e.config.autoCollapse:!0,watchInternalChanges:"undefined"!=typeof e.config.watchInternalChanges?e.config.watchInternalChanges:!1,headerClass:e.config.headerClass||"",beforeHeader:e.config.beforeHeader||'<div class="sir-accordion-vertical-align"><div>',afterHeader:e.config.afterHeader||"</div></div>",topContentClass:e.config.topContentClass||"",beforeTopContent:e.config.beforeTopContent||"",afterTopContent:e.config.afterTopContent||"",bottomContentClass:e.config.bottomContentClass||"",beforeBottomContent:e.config.beforeBottomContent||"",afterBottomContent:e.config.afterBottomContent||""}}],link:function(o,t){var i=o.config.animDur,a="",l="",c="",r="",d=[],f=[],s=!1,u="0",g="background: #0044CE; color: #fff",p=null;o.$watch("collection",function(){if(!angular.isArray(o.collection))return void t.html("No collection found");a="",l="",c="",r="",d=[],f=[],s=!1,u="0",r=h(o.collection,0,0,0),t.html(""),p&&(p.$destroy(),p=null),p=o.$new();var n=e(r)(p);t.append(n),C(),o.$emit("sacDoneLoading"),o.config.expandFirst&&O("1")},o.config.watchInternalChanges);var C=function(){for(var e=null,n=null,o=null,t=f.length-1;t>=0;t--)e=document.getElementById("sac"+f[t]),n=e.firstElementChild?e.firstElementChild:e.firstChild,o=n.nextSibling,f[t]={id:e.id,obj:o},d[t]={id:e.id,obj:n},e.firstElementChild&&(d[t].obj.style.transition="all "+i+"ms")},h=function(e,n,t,i){return t==e.length?"":(c=i?String(n)+"-"+String(t+1):String(t+1),a=o.config.beforeHeader+e[t].title+o.config.afterHeader,f.push(c),l='<div id="sac'+c+'" ><div class="sir-accordion-header '+o.config.headerClass+'" ng-click="expandCollapseProgrammatically(\''+c+"')\">"+a+'</div><div class="sir-accordion-content"><div><div class="'+o.config.topContentClass+'">'+v(o.config.beforeTopContent,e[t].topContent,o.config.afterTopContent)+"</div>",0==t&&(l=0==i?'<div class="sir-accordion-wrapper">'+l:'<div class="sir-accordion-group">'+l),angular.isArray(e[t].subCollection)&&e[t].subCollection.length?(l+=h(e[t].subCollection,c,0,i+1),l=l+'</div><div class="'+o.config.bottomContentClass+'">'+v(o.config.beforeBottomContent,e[t].bottomContent,o.config.afterBottomContent)+"</div></div></div></div>"):l=l+'<div class="'+o.config.bottomContentClass+'">'+v(o.config.beforeBottomContent,e[t].bottomContent,o.config.afterBottomContent)+"</div></div></div></div>",l+h(e,n,t+1,i))},v=function(e,n,o){return n=n?e+n+o:""},m=function(e,n){if(o.config.debug&&console.log("Chain collapsing"),!(b(e)<=n))do{for(var t=f.length-1;t>=0;t--)o.config.autoCollapse&&f[t].id=="sac"+e?(y(f[t],"expanded"),y(d[t],"active-header")):x(f[t].id)==x(e)&&f[t].obj.className.indexOf("expanded")>-1&&(y(f[t],"expanded"),y(d[t],"active-header"));e=x(e)}while(b(e)!=n)},b=function(e){return"0"==e?0:e.split("-").length},x=function(e){if(-1==e.indexOf("-"))return"0";var n="";do n=e.substr(e.length-1),e=e.slice(0,-1);while("-"!=n);return e=e.replace("sac","")},y=function(e,n){var t=null;return e.obj.className.indexOf(n)>-1?(e.obj.className=e.obj.className.replace(n,""),o.config.debug&&console.log("removing class "+e.id),"expanded"==n&&(t=e.obj.firstElementChild?e.obj.firstElementChild:e.obj.firstChild,j(t,"finish"),j(t,"slideUp",{display:null,duration:i,complete:function(){t.style.height="0px"}})),!0):(e.obj.className=E(e.obj.className)+" "+n,o.config.debug&&console.log("adding class "+e.id),"expanded"==n&&(t=e.obj.firstElementChild?e.obj.firstElementChild:e.obj.firstChild,j(t,"finish"),j(t,"slideDown",{delay:0,duration:i,progress:function(){e.obj.style.height="auto"},begin:function(){e.obj.style.height="0px",t.style.height="auto"}})),!0)},j=function(e,n,o){return"undefined"==typeof Velocity?void(o?$(e).velocity(n,o):$(e).velocity(n)):void(o?Velocity(e,n,o):Velocity(e,n))},N=function(e,n){do{if(x(n)==e)return!0;n=x(n)}while(b(n)>b(e));return!1},E=function(e){for(var e=e.replace(/^\s\s*/,""),n=/\s/,o=e.length;n.test(e.charAt(--o)););return e.slice(0,o+1)},w=function(e){for(var n=f.length-1;n>=0;n--)if(f[n].id=="sac"+e||f[n].id==e)return n;return-1},B=function(e,n){for(var o=e.length-1;o>=0;o--)N(n,e[o].id)&&e[o].obj.className.indexOf("expanded")>-1&&(y(e[o],"expanded"),y(d[o],"active-header"))},O=function(e){if("0"==e)return D(),void(u="0");if(e!=u){if(N(e,u))return m(u,b(e)),void(u=e);var n=e.split("-"),t=u.split("-"),i="",a=0,l=0,c=0;if(o.config.autoCollapse&&"0"!=u){for(var r=0;r<n.length||r<t.length;r++)n[r]!=t[r]||c?c++:l++;if(c>1&&l<b(e))for(var s=t.length-l,p=u;s>0;)y(f[w(p)],"expanded"),y(d[w(p)],"active-header"),p=x(p),s--;else m(u,b(e)-1)}for(var r=0;r<n.length;r++){for(var C=0;r>=C;C++)i=C?i+"-"+n[C]:n[C];f[w(i)]?-1==f[w(i)].obj.className.indexOf("expanded")?(I(f[w(i)],d[w(i)],a),u=i):a--:o.config.debug&&console.log("%c Coordinate does not match an element",g),i=""}}};o.expandCollapseProgrammatically=function(e){s||(-1!=f[w(e)].obj.className.indexOf("expanded")?A(e):O(e))};var A=function(e){-1!=f[w(e)].obj.className.indexOf("expanded")&&(B(f,e),y(f[w(e)],"expanded"),y(d[w(e)],"active-header"),u=x(e))},I=function(e,o,t){n(function(){y(e,"expanded"),y(o,"active-header")},i*(b(e.id)-1+t))},D=function(){u="0";for(var e=f.length-1;e>=0;e--)f[e].obj.className.indexOf("expanded")>-1&&(y(f[e],"expanded"),y(d[e],"active-header"))};o.$on("sacCollapseAll",function(e){D(),e.defaultPrevented=!0}),o.$on("sacExpandAll",function(e,n){if(!o.config.autoCollapse)for(var t=0;t<=f.length-1;t++)-1==f[t].obj.className.indexOf("expanded")&&I(f[t],d[t],0);e.defaultPrevented=!0}),o.$on("sacExpandContentById",function(e,n){O(n),e.defaultPrevented=!0}),o.$on("sacCollapseContentById",function(e,n){A(n),e.defaultPrevented=!0})}}}]);